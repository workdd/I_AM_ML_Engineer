# 속도의 한계를 뛰어넘다: HyperCLOVA X에 적용한 Speculative Decoding 이야기

- **출처**: [CLOVA 기술 블로그](https://clova.ai/tech-blog/속도의-한계를-뛰어넘다-hyperclova-x에-적용한-speculative-decoding-이야기)
- **저자**: 네이버클라우드 CLOVA 팀
- **읽은 날짜**: 2025-12-22
- **태그**: #LLM #SpeculativeDecoding #추론최적화 #HyperCLOVA

## 핵심 내용

HyperCLOVA X에 Speculative Decoding을 적용하여 LLM 추론 속도를 개선한 사례.

### 문제 정의
> "모델이 커질수록 지연이 커지고, 하드웨어 성능만으로는 속도 개선에 한계"

- LLM은 토큰을 **순차적으로** 생성 → 근본적 병목
- 모델 크기 증가 → latency 증가
- 하드웨어 스케일업만으로는 한계

## Speculative Decoding 원리

### 작동 메커니즘
```
┌─────────────────┐     ┌─────────────────┐
│  Draft Model    │ ──▶ │  Target Model   │
│  (소형, 빠름)   │     │  (대형, 정확)   │
└─────────────────┘     └─────────────────┘
   여러 토큰 예측          병렬로 검증
         │                      │
         └──────────────────────┘
              일치 → 채택
              불일치 → 재생성
```

1. **Draft Model**: 작은 모델이 여러 토큰을 빠르게 예측
2. **Target Model**: 큰 모델이 예측값들을 **병렬로** 검증
3. 일치하는 토큰은 채택, 불일치는 재생성

### 핵심: 분포 보존
- **Rejection Sampling** 기법 사용
- 원본 모델의 생성 분포를 **완전히 보존**
- 예: Target이 "안녕" 70% 확률 → 결과도 동일 비율 유지
- 품질 손실 없이 속도만 향상!

## 성능 결정 요인

| 요소 | 트레이드오프 |
|------|-------------|
| Draft 모델 크기 | 너무 작으면 채택률 ↓ |
| 예측 길이 (짧음) | 가속 효과 제한 |
| 예측 길이 (김) | 검증 실패율 ↑ |

**채택률 × 예측 길이** 최적화가 핵심

## HyperCLOVA X 적용 전략

### 동적 조정 시스템
고정 설정 대신 **실시간 최적화** 도입:

| 상황 | 전략 |
|------|------|
| 시스템 자원 충분 | 예측 범위 확대 → 속도 극대화 |
| 부하 높음 / 입력 김 | 예측 범위 축소 → 안정성 우선 |

> "동적 조정 전략이 고정 설정보다 더 빠른 처리 속도와 안정성을 모두 달성"

## 인상 깊은 부분

### 분포 보존의 중요성
- 단순 속도 향상이 아닌 **품질 유지**가 핵심
- Rejection Sampling으로 수학적으로 동일한 분포 보장
- 프로덕션 환경에서 이게 없으면 도입 불가능

### 동적 조정의 실용성
- 실험실 벤치마크 ≠ 실제 운영 환경
- 고정 설정은 worst case에서 성능 저하
- 실시간 환경 변화에 적응하는 전략 필수

## 내 생각 / 적용점

### 배운 점
1. **Speculative Decoding = Draft + Target + Rejection Sampling**
2. 속도 향상과 품질 보존을 **동시에** 달성 가능
3. 프로덕션에서는 **동적 조정**이 핵심

### 실무 연결
- vLLM에서 Speculative Decoding 지원 → 바로 적용 가능
- Draft 모델 선택이 중요 (같은 vocab, 비슷한 분포)
- 모니터링: 채택률, 예측 길이, latency 트래킹 필요

### 후속 학습
- [ ] Rejection Sampling 수학적 원리
- [ ] Draft 모델 학습 방법 (distillation?)
- [ ] vLLM Speculative Decoding 실습
- [ ] Medusa, EAGLE 등 다른 방식과 비교
